<!doctype html>
<html>
<head>
<title>Imagemacro Generator for subreddit /r/TotallyLooksLike</title>
<meta charset="UTF-8">
<style>
body, html
{
  width: 100%; height: 100%; position: relative; margin: 0; padding: 0; box-sizing: border-box;
  display: flex; align-items: center; justify-content: center;
  font-family: arial; font-size: 12pt; 
}
page { text-align: center; }
#product { width: 603px; height: 482px; border 1px solid red; position: relative; }
img.preload { position: absolute; top: -9999px; left: -9999px; }
.inputRow   { position: relative; }
.inputLabel { text-align: center; position: absolute; width: 183px; margin: 0 210px; }
input { width: 200px; }
#caption2 { float: right; text-align: right; }
#url2 { float: right; text-align: right; }
</style>
<script>

window.PRODUCT_WIDTH = 603;
window.PRODUCT_HEIGHT = 482;
window.PRODUCT_DIVIDER = PRODUCT_WIDTH/2.0;
window.PRODUCT_BACKGROUND = 'white';
window.PRODUCT_BORDER_STYLE = 'black';

window.CAPTION_BOX_SIZE = 30;
window.CAPTION_BOX_COLOR = 'rgba(255, 255, 255, 0.66)';
window.CAPTION_FONT_STYLE = 'bold 12pt Arial';
window.CAPTION_FONT_COLOR = 'black';
window.CAPTION_BASELINE = 472;
window.CAPTION_INSET = 10;

window.REDRAW_TIMEOUT = 333; // in milliseconds
window.redrawTimer = null;

window.PIC_WIDTH = (PRODUCT_WIDTH-3)/2;
window.PIC_HEIGHT = PRODUCT_HEIGHT-2;
window.PIC_SCALE_MIN = 0.01;
window.PIC_SCALE_MAX = 20;
window.picDragging = 0;
window.picDragAnchor = {};
window.picDetails = {
  1: {"x": 0, "y": 0, "scale": 1},
  2: {"x": -50, "y": 0, "scale": 1},
};


CanvasRenderingContext2D.prototype.fillTextCenterX = function(text, x, y)
{
  this.fillText(text, x - (this.measureText(text).width/2), y);
};

CanvasRenderingContext2D.prototype.fillTextRight = function(text, x, y)
{
  this.fillText(text, x - (this.measureText(text).width), y);
};

function PreparePic(ctx, which, url)
{
  var picObj = document.getElementById('pic'+ which);
  if(url != picObj.src)
  {
    picObj.src = url;
    picObj.onload = function() { PreDraw(); };
  } else {
    DrawPic(ctx, which);
  }
}

function DrawPic(ctx, which)
{
  var picObj = document.getElementById('pic'+ which);
  var sourceWidth  = PIC_WIDTH  / picDetails[which].scale;
  var sourceHeight = PIC_HEIGHT / picDetails[which].scale;

  var sourceX      = picObj.naturalWidth/2.0  + (PIC_WIDTH/-2.0  + picDetails[which].x)/picDetails[which].scale;
  var sourceY      = picObj.naturalHeight/2.0 + (PIC_HEIGHT/-2.0 + picDetails[which].y)/picDetails[which].scale;

  var destX = which + PIC_WIDTH*(which-1);
  var destY = 1;

  ctx.drawImage(picObj, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, PIC_WIDTH, PIC_HEIGHT);
}

function StartDrag(event)
{
  var which = (event.clientX - product.getBoundingClientRect().left < PRODUCT_DIVIDER)?1:2;
  picDragAnchor = { "destX": event.screenX, "destY": event.screenY, "sourceX": picDetails[which].x, "sourceY": picDetails[which].y };
  
  picDragging = which;
}

function StopDrag(event)
{
  picDragging = 0;
}

function Drag(event)
{
  if(picDragging<1) { return; } // This indicates that no drag operation is active
  picDetails[picDragging].x = picDragAnchor.sourceX + picDragAnchor.destX - event.screenX;
  picDetails[picDragging].y = picDragAnchor.sourceY + picDragAnchor.destY - event.screenY;
  PreDraw();
}

function ClampScale(which)
{
  if(picDetails[which].scale < PIC_SCALE_MIN) { picDetails[which].scale = PIC_SCALE_MIN; }
  if(picDetails[which].scale > PIC_SCALE_MAX) { picDetails[which].scale = PIC_SCALE_MAX; }
}

function WheelZoom(event)
{
  var which = (event.clientX - product.getBoundingClientRect().left < PRODUCT_DIVIDER)?1:2;
  picDetails[which].scale *= (1 + event.deltaY/1000.0);
  ClampScale(which);
  PreDraw();
}

function PreDraw()
{
  cancelAnimationFrame(redrawTimer);
  redrawTimer = requestAnimationFrame(ReDraw);
}

function ReDraw()
{
  var ctx = product.getContext("2d");

  ctx.beginPath();
  ctx.rect(0.5, 0.5, PRODUCT_WIDTH-1, PRODUCT_HEIGHT-1); // Outside Border
  ctx.rect(PRODUCT_DIVIDER, 0.5, 0, PRODUCT_HEIGHT-1); // Divider
  ctx.fillStyle = PRODUCT_BACKGROUND;
  ctx.fill();
  ctx.strokeStyle = PRODUCT_BORDER_STYLE;
  ctx.stroke();

  PreparePic(ctx, 1, document.getElementById('url1').value);
  PreparePic(ctx, 2, document.getElementById('url2').value);

  ctx.beginPath();
  ctx.rect(0.5, PRODUCT_HEIGHT-CAPTION_BOX_SIZE-0.5, PRODUCT_WIDTH-1, CAPTION_BOX_SIZE); // Caption Area
  ctx.fillStyle = CAPTION_BOX_COLOR;
  ctx.strokeStyle = PRODUCT_BORDER_STYLE;
  ctx.fill();
  ctx.stroke();

  ctx.font = CAPTION_FONT_STYLE;
  ctx.fillStyle = CAPTION_FONT_COLOR;
  ctx.fillTextCenterX("/r/TotallyLooksLike", PRODUCT_DIVIDER, CAPTION_BASELINE);
//  ctx.fillTextCenterX((new Date()).getMilliseconds(), 20, 20);
  ctx.fillText(document.getElementById('caption1').value, CAPTION_INSET, CAPTION_BASELINE);
  ctx.fillTextRight(document.getElementById('caption2').value, PRODUCT_WIDTH - CAPTION_INSET, CAPTION_BASELINE);
}

function init()
{
  window.product = document.getElementById("product");
  window.onmousemove = window.Drag;
  product.onmousedown = window.StartDrag;
  window.onmouseup = window.StopDrag;
  product.onwheel = window.WheelZoom;
  ReDraw();
}

</script>
</head>
<body onLoad='init()'>
<div id='page'>
  <canvas id="product" width="603" height="482"></canvas><br>
  <div class='inputRow'>
    <div class='inputLabel'>&lt;- Captions -&gt;</div>
    <input type='text' id='caption1' oninput='PreDraw()' value='Darth Vader'>
    <input type='text' id='caption2' oninput='PreDraw()' value='Bane Cosplayer'>
  </div>
  <div class='inputRow'>
    <div class='inputLabel'>&lt;- URLs -&gt;</div>
    <input type='text' id='url1' oninput='PreDraw()' value='http://www.html5canvastutorials.com/demos/assets/darth-vader.jpg'>
    <input type='text' id='url2' oninput='PreDraw()' value='http://2.bp.blogspot.com/-CYdB6HpOE4Y/Tkg5FvaSlBI/AAAAAAAAEPA/Ou12J0cdJIg/s1600/baned.jpg'>
  </div>
</div>
<img class='preload' id='pic1'></img>
<img class='preload' id='pic2'></img>
</body>
</html>
